<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library Management System - Advanced Reports</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            color: #333;
            line-height: 1.6;
        }
        header {
            background-color: #333;
            color: white;
            padding: 1em 2em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        header h1 {
            margin: 0;
            font-size: 1.8em;
        }
        nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
        }
        nav ul li {
            margin-left: 1em;
        }
        nav ul li a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
        }
        nav ul li a i {
            margin-right: 0.3em;
        }
        nav ul li a.active {
            font-weight: bold;
        }
        nav ul li button {
            background: none;
            color: white;
            border: none;
            padding: 0;
            font-size: inherit;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        nav ul li button i {
            margin-right: 0.3em;
        }
        main {
            padding: 1.5em;
        }
        .report-section {
            background-color: #fff;
            padding: 1em;
            margin-bottom: 1.5em;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8em;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.3em;
        }
        .report-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.2em;
        }
        .report-content {
            padding-top: 0.8em;
        }
        .filter-options {
            display: flex;
            gap: 0.8em;
            margin-bottom: 0.8em;
            align-items: center;
            flex-wrap: wrap;
        }
        .filter-options label {
            font-weight: bold;
            font-size: 0.9em;
        }
        .filter-options select,
        .filter-options input[type="date"],
        .filter-options .flatpickr-wrapper {
            padding: 0.4em;
            border: 1px solid #ccc;
            border-radius: 4px;
            min-width: 100px;
            font-size: 0.8em;
        }
        .filter-options button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 0.5em 0.8em;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
        }
        .filter-options button:hover {
            background-color: #0056b3;
        }
        .report-table-container {
            overflow-x: auto;
            margin-bottom: 0.8em;
        }
        .report-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8em;
        }
        .report-table th, .report-table td {
            padding: 0.6em;
            border-bottom: 1px solid #eee;
            text-align: left;
        }
        .report-table th {
            background-color: #f8f8f8;
            font-weight: bold;
            color: #555;
        }
        .report-table tr:hover {
            background-color: #f9f9f9;
        }
        #fines-report .report-table td.paid {
            color: green;
            font-weight: bold;
        }
        #fines-report .report-table td.unpaid {
            color: red;
            font-weight: bold;
        }
        .graphs-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5em;
            margin-bottom: 1.5em;
        }
        .graph-container {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            padding: 1em;
        }
        .graph-container h3 {
            margin-top: 0;
            color: #333;
            font-size: 1em;
            margin-bottom: 0.5em;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.3em;
        }
        #borrowingTrendsChart, #userActivityChart, #bookPopularityChart {
            width: 100%;
            height: 200px;
        }
        /* Loading Overlay Styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10; /* Ensure it's on top */
        }
        .loading-spinner {
            border: 3px solid #f3f3f3; /* Light grey */
            border-top: 3px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden {
            display: none !important;
        }
        .report-generate-options {
            background-color: #f9f9f9;
            padding: 1em;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5em;
        }
        .report-generate-options h2 {
            color: #333;
            font-size: 1.2em;
            margin-top: 0;
            margin-bottom: 0.5em;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.3em;
        }
        .report-generate-options .option-group {
            margin-bottom: 0.8em;
        }
        .report-generate-options label {
            display: block;
            margin-bottom: 0.3em;
            font-weight: bold;
            font-size: 0.9em;
        }
        .report-generate-options input[type="date"],
        .report-generate-options select,
        .report-generate-options button {
            padding: 0.5em;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.8em;
        }
        .report-generate-options button {
            background-color: #28a745;
            color: white;
            border: none;
            cursor: pointer;
        }
        .report-generate-options button:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>
    <header>
        <h1>Library Management System</h1>
        <nav>
            <ul>
                <li><a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a href="books.html"><i class="fas fa-book"></i> Books</a></li>
                <li><a href="members.html"><i class="fas fa-users"></i> Members</a></li>
                <li><a href="transactions.html"><i class="fas fa-exchange-alt"></i> Transactions</a></li>
                <li><a href="reports.html" class="active"><i class="fas fa-chart-bar"></i> Reports</a></li>
                <li><button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button></li>
            </ul>
        </nav>
    </header>
    <main>
        <div id="loadingOverlay" class="loading-overlay hidden">
            <div class="loading-spinner"></div>
        </div>

        <section class="report-generate-options">
            <h2>Generate Custom Reports</h2>

            <div class="option-group">
                <label for="reportType">Report Type:</label>
                <select id="reportType">
                    <option value="">Select Report Type</option>
                    <option value="book_borrowing">Book Borrowing History</option>
                    <option value="user_borrowing">User Borrowing History</option>
                    <option value="transaction_log">Transaction Log</option>
                    <option value="new_members">New Members Registered</option>
                    <option value="new_books">New Books Added</option>
                </select>
            </div>

            <div class="option-group" id="dateRangeGroup" style="display: none;">
                <label for="startDate">Start Date:</label>
                <input type="date" id="startDate">
                <label for="endDate">End Date:</label>
                <input type="date" id="endDate">
            </div>

            <div class="option-group" id="bookSelectGroup" style="display: none;">
                <label for="selectedBook">Select Book:</label>
                <select id="selectedBook">
                    <option value="">Select a Book</option>
                    </select>
            </div>

            <div class="option-group" id="userSelectGroup" style="display: none;">
                <label for="selectedUser">Select User:</label>
                <select id="selectedUser">
                    <option value="">Select a User</option>
                    </select>
            </div>

            <button onclick="generateCustomReport()">Generate Report</button>

            <div id="customReportOutput" class="report-content" style="margin-top: 1.5em;">
                </div>
        </section>

        <section id="graphs-section" class="report-section">
            <div class="report-header">
                <h2>Visual Reports & Analytics</h2>
            </div>
            <div class="report-content">
                <div class="graphs-container">
                    <div class="graph-container">
                        <h3>Book Borrowing Trends</h3>
                        <canvas id="borrowingTrendsChart"></canvas>
                        <div class="filter-options">
                            <label for="borrowingTrendsTimeframe">Timeframe:</label>
                            <select id="borrowingTrendsTimeframe">
                                <option value="last7days">Last 7 Days</option>
                                <option value="last30days">Last 30 Days</option>
                                <option value="thisMonth">This Month</option>
                                <option value="lastMonth">Last Month</option>
                                <option value="thisYear">This Year</option>
                                <option value="allTime">All Time</option>
                                <option value="custom">Custom Range</option>
                            </select>
                            <div id="customBorrowingRange" style="display: none;">
                                <label for="borrowingStart">Start:</label>
                                <input type="date" id="borrowingStart">
                                <label for="borrowingEnd">End:</label>
                                <input type="date" id="borrowingEnd">
                                <button onclick="updateBorrowingTrends('custom')">Apply</button>
                            </div>
                        </div>
                    </div>

                    <div class="graph-container">
                        <h3>User Activity</h3>
                        <canvas id="userActivityChart"></canvas>
                        <div class="filter-options">
                            <label for="userActivityTimeframe">Timeframe:</label>
                            <select id="userActivityTimeframe">
                                <option value="last7days">Last 7 Days</option>
                                <option value="last30days">Last 30 Days</option>
                                <option value="thisMonth">This Month</option>
                                <option value="lastMonth">Last Month</option>
                                <option value="thisYear">This Year</option>
                                <option value="allTime">All Time</option>
                                <option value="custom">Custom Range</option>
                            </select>
                            <div id="customUserActivityRange" style="display: none;">
                                <label for="userActivityStart">Start:</label>
                                <input type="date" id="userActivityStart">
                                <label for="userActivityEnd">End:</label>
                                <input type="date" id="userActivityEnd">
                                <button onclick="updateUserActivityChart('custom')">Apply</button>
                            </div>
                        </div>
                    </div>

                    <div class="graph-container">
                        <h3>Most Popular Books</h3>
                        <canvas id="bookPopularityChart"></canvas>
                        <div class="filter-options">
                            <label for="popularityTimeframe">Timeframe:</label>
                            <select id="popularityTimeframe">
                                <option value="last30days">Last 30 Days</option>
                                <option value="thisYear">This Year</option>
                                <option value="allTime">All Time</option>
                                </select>
                            <label for="popularityLimit">Top:</label>
                            <select id="popularityLimit">
                                <option value="5">5</option>
                                <option value="10">10</option>
                                <option value="20">20</option>
                            </select>
                            <button onclick="updateBookPopularity()">Update</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="tabular-reports" class="report-section">
            <div class="report-header">
                <h2>Detailed Tabular Reports</h2>
            </div>
            <div class="report-content">
                <section id="overdue-report">
                    <h3>Overdue Books</h3>
                    <div class="report-table-container">
                        <table class="report-table" id="overdueBooksTable">
                            <thead>
                                <tr>
                                    <th>Book Title</th>
                                    <th>Member Name</th>
                                    <th>Checkout Date</th>
                                    <th>Due Date</th>
                                    <th>Days Overdue</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>

                </div>
        </section>
    </main>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    // Firebase Configuration (replace with your actual config)
    const firebaseConfig = {
        apiKey: "AIzaSyBPQ67r9mMz-x8fOCXozbVGMW_de81b0_8",
        authDomain: "stakehub-fc6be.firebaseapp.com",
        databaseURL: "https://stakehub-fc6be-default-rtdb.firebaseio.com",
        projectId: "stakehub-fc6be",
        storageBucket: "stakehub-fc6be.appspot.com",
        messagingSenderId: "990758331124",
        appId: "1:990758331124:android:11851d9fb54fa6d8eef4a1"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const dbRef = firebase.database().ref();

    // Get table bodies
    const overdueBooksTableBody = document.getElementById('overdueBooksTable').querySelector('tbody');
    // const finesTableBody = document.getElementById('finesTable').querySelector('tbody'); // Commented out
    let allFinesData = []; // Commented out

    // Get filter elements for fines
    // const filterFinesButton = document.getElementById('filterFines'); // Commented out
    // const fineStatusSelect = document.getElementById('fineStatus'); // Commented out

    // Get graph elements
    const borrowingTrendsChartCanvas = document.getElementById('borrowingTrendsChart');
    const userActivityChartCanvas = document.getElementById('userActivityChart');
    const bookPopularityChartCanvas = document.getElementById('bookPopularityChart');
    let borrowingTrendsChart, userActivityChart, bookPopularityChart;

    // Get filter elements for borrowing trends chart
    const borrowingTrendsTimeframeSelect = document.getElementById('borrowingTrendsTimeframe');
    const customBorrowingRangeDiv = document.getElementById('customBorrowingRange');
    const borrowingStartInput = document.getElementById('borrowingStart');
    const borrowingEndInput = document.getElementById('borrowingEnd');

    // Get filter elements for user activity chart
    const userActivityTimeframeSelect = document.getElementById('userActivityTimeframe');
    const customUserActivityRangeDiv = document.getElementById('customUserActivityRange');
    const userActivityStartInput = document.getElementById('userActivityStart');
    const userActivityEndInput = document.getElementById('userActivityEnd');

    // Get filter elements for book popularity chart
    const popularityTimeframeSelect = document.getElementById('popularityTimeframe');
    const popularityLimitSelect = document.getElementById('popularityLimit');

    // Get loading overlay
    const loadingOverlay = document.getElementById('loadingOverlay');

    // Custom Report Generation Elements
    const reportTypeSelect = document.getElementById('reportType');
    const dateRangeGroup = document.getElementById('dateRangeGroup');
    const bookSelectGroup = document.getElementById('bookSelectGroup');
    const userSelectGroup = document.getElementById('userSelectGroup');
    const selectedBookSelect = document.getElementById('selectedBook');
    const selectedUserSelect = document.getElementById('selectedUser');
    const customReportOutputDiv = document.getElementById('customReportOutput');

    let allBooks = [];
    let allMembers = [];

    // Function to show loading overlay
    const showLoading = () => {
        loadingOverlay.classList.remove('hidden');
    };

    // Function to hide loading overlay
    const hideLoading = () => {
        loadingOverlay.classList.add('hidden');
    };

    // Function to get data as an array from a Firebase snapshot
    const snapshotToArray = (snapshot) => {
        const dataArray = [];
        snapshot.forEach(childSnapshot => {
            const item = childSnapshot.val();
            item.id = childSnapshot.key;
            dataArray.push(item);
        });
        return dataArray;
    };

    firebase.auth().onAuthStateChanged(user => {
        if (user) {
            // Check if the user is an admin
            dbRef.child('admins').child(user.uid).once('value', adminSnapshot => {
                if (!adminSnapshot.exists()) {
                    console.log("User is not an administrator.");
                    window.location.href = 'index.html?unauthorized=true';
                } else {
                    loadOverdueBooks();
                    // loadFines(); // Commented out
                    loadBorrowingTrends('last30days');
                    loadUserActivity('last30days');
                    loadPopularBooks('last30days', 5); // Default to top 5
                    loadAllBooksForSelect();
                    loadAllMembersForSelect();
                }
            });
        } else {
            // User is not signed in, redirect to login
            window.location.href = 'index.html';
        }
    });

    function loadAllBooksForSelect() {
        dbRef.child('books').once('value', snapshot => {
            allBooks = snapshotToArray(snapshot);
            selectedBookSelect.innerHTML = '<option value="">Select a Book</option>';
            allBooks.forEach(book => {
                const option = document.createElement('option');
                option.value = book.id;
                option.textContent = book.title;
                selectedBookSelect.appendChild(option);
            });
        });
    }

    function loadAllMembersForSelect() {
        dbRef.child('members').once('value', snapshot => {
            allMembers = snapshotToArray(snapshot);
            selectedUserSelect.innerHTML = '<option value="">Select a User</option>';
            allMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = member.name;
                selectedUserSelect.appendChild(option);
            });
        });
    }

    function loadOverdueBooks() {
        showLoading();
        overdueBooksTableBody.innerHTML = '';
        const now = new Date();

        dbRef.child('transactions').orderByChild('status').equalTo('checked_out').once('value', snapshot => {
            const transactions = snapshotToArray(snapshot);
            let overdueTransactions = [];

            transactions.forEach(transaction => {
                if (transaction.dueDate) {
                    const dueDate = new Date(transaction.dueDate);
                    if (dueDate < now) {
                        overdueTransactions.push(transaction);
                    }
                }
            });

            if (overdueTransactions.length > 0) {
                overdueTransactions.forEach(transaction => {
                    Promise.all([
                        dbRef.child('books').child(transaction.bookId).once('value'),
                        dbRef.child('members').child(transaction.memberId).once('value')
                    ]).then(([bookSnapshot, memberSnapshot]) => {
                        if (bookSnapshot.exists() && memberSnapshot.exists()) {
                            const book = bookSnapshot.val();
                            const member = memberSnapshot.val();
                            const dueDate = new Date(transaction.dueDate);
                            const timeDiff = Math.abs(now.getTime() - dueDate.getTime());
                            const daysOverdue = Math.ceil(timeDiff / (1000 * 3600 * 24));

                            const row = overdueBooksTableBody.insertRow();
                            row.insertCell().textContent = book.title || 'N/A';
                            row.insertCell().textContent = member.name || 'N/A';
                            row.insertCell().textContent = transaction.checkoutDate ? new Date(transaction.checkoutDate).toLocaleDateString() : 'N/A';
                            row.insertCell().textContent = dueDate.toLocaleDateString();
                            row.insertCell().textContent = daysOverdue;
                        }
                    });
                });
            } else {
                const row = overdueBooksTableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 5;
                cell.textContent = 'No overdue books at this time.';
            }
        }).finally(hideLoading);
    }

    // function loadFines() { // Commented out
    //     showLoading();
    //     finesTableBody.innerHTML = '';
    //     dbRef.child('fines').once('value', snapshot => {
    //         allFinesData = snapshotToArray(snapshot);
    //         displayFines(allFinesData);
    //     }).finally(hideLoading);
    // }

    // function displayFines(fines) { // Commented out
    //     finesTableBody.innerHTML = '';
    //     if (fines.length > 0) {
    //         fines.forEach(fine => {
    //             Promise.all([
    //                 dbRef.child('members').child(fine.memberId).once('value'),
    //                 dbRef.child('books').child(fine.bookId).once('value')
    //             ]).then(([memberSnapshot, bookSnapshot]) => {
    //                 if (memberSnapshot.exists() && bookSnapshot.exists()) {
    //                     const member = memberSnapshot.val();
    //                     const book = bookSnapshot.val();
    //                     const row = finesTableBody.insertRow();
    //                     row.insertCell().textContent = member.name || 'N/A';
    //                     row.insertCell().textContent = book.title || 'N/A';
    //                     row.insertCell().textContent = fine.dueDate ? new Date(fine.dueDate).toLocaleDateString() : 'N/A';
    //                     row.insertCell().textContent = fine.returnDate ? new Date(fine.returnDate).toLocaleDateString() : 'N/A';
    //                     row.insertCell().textContent = fine.daysOverdue || 'N/A';
    //                     row.insertCell().textContent = fine.amount ? parseFloat(fine.amount).toFixed(2) : 'N/A';
    //                     const statusCell = row.insertCell();
    //                     statusCell.textContent = fine.paid ? 'Paid' : 'Unpaid';
    //                     statusCell.classList.add(fine.paid ? 'paid' : 'unpaid');
    //                 }
    //             });
    //         });
    //     } else {
    //         const row = finesTableBody.insertRow();
    //         const cell = row.insertCell();
    //         cell.colSpan = 7;
    //         cell.textContent = 'No fines recorded.';
    //     }
    // }

    // filterFinesButton.addEventListener('click', () => { // Commented out
    //     const selectedStatus = fineStatusSelect.value;
    //     const filteredFines = selectedStatus ? allFinesData.filter(fine => (selectedStatus === 'paid' && fine.paid) || (selectedStatus === 'unpaid' && !fine.paid)) : allFinesData;
    //     displayFines(filteredFines);
    // });

    function loadBorrowingTrends(timeframe, startDate = null, endDate = null) {
        showLoading();
        dbRef.child('transactions').orderByChild('checkoutDate').once('value', snapshot => {
            const transactions = snapshotToArray(snapshot);
            const bookCheckoutCounts = {};
            const now = new Date();
            let filteredTransactions = transactions;

            if (timeframe === 'last7days') {
                const pastDate = new Date(now);
                pastDate.setDate(now.getDate() - 7);
                filteredTransactions = transactions.filter(t => t.checkoutDate && new Date(t.checkoutDate) >= pastDate);
            } else if (timeframe === 'last30days') {
                const pastDate = new Date(now);
                pastDate.setDate(now.getDate() - 30);
                filteredTransactions = transactions.filter(t => t.checkoutDate && new Date(t.checkoutDate) >= pastDate);
            } else if (timeframe === 'thisMonth') {
                filteredTransactions = transactions.filter(t => t.checkoutDate && new Date(t.checkoutDate).getMonth() === now.getMonth() && new Date(t.checkoutDate).getFullYear() === now.getFullYear());
            } else if (timeframe === 'lastMonth') {
                const lastMonth = now.getMonth() === 0 ? 11 : now.getMonth() - 1;
                const year = now.getMonth() === 0 ? now.getFullYear() - 1 : now.getFullYear();
                filteredTransactions = transactions.filter(t => t.checkoutDate && new Date(t.checkoutDate).getMonth() === lastMonth && new Date(t.checkoutDate).getFullYear() === year);
            } else if (timeframe === 'thisYear') {
                filteredTransactions = transactions.filter(t => t.checkoutDate && new Date(t.checkoutDate).getFullYear() === now.getFullYear());
            } else if (timeframe === 'allTime') {
                // Keep all transactions
            } else if (timeframe === 'custom' && startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                filteredTransactions = transactions.filter(t => t.checkoutDate && new Date(t.checkoutDate) >= start && new Date(t.checkoutDate) <= end);
            }

            filteredTransactions.forEach(transaction => {
                bookCheckoutCounts[transaction.bookId] = (bookCheckoutCounts[transaction.bookId] || 0) + 1;
            });

            const sortedTrends = Object.entries(bookCheckoutCounts).sort(([, countA], [, countB]) => countB - countA).slice(0, 5); // Show top 5
            const labels = [];
            const data = [];

            Promise.all(sortedTrends.map(([bookId]) => dbRef.child('books').child(bookId).once('value')))
                .then(snapshots => {
                    snapshots.forEach(snapshot => {
                        if (snapshot.exists()) {
                            labels.push(snapshot.val().title || 'N/A');
                            const bookId = snapshot.key;
                            data.push(bookCheckoutCounts[bookId] || 0);
                        }
                    });
                    renderBorrowingTrendsChart(labels, data);
                })
                .finally(hideLoading);
        });
    }

    function renderBorrowingTrendsChart(labels, data) {
        if (borrowingTrendsChart) {
            borrowingTrendsChart.destroy();
        }
        borrowingTrendsChart = new Chart(borrowingTrendsChartCanvas, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Checkouts',
                    data: data,
                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Count',
                            font: { size: 10 }
                        },
                        ticks: { fontSize: 8 }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Book',
                            font: { size: 10 }
                        },
                        ticks: { fontSize: 8 }
                    }
                },
                plugins: {
                    legend: { display: false },
                    title: { display: true, text: 'Borrowing Trends', font: { size: 12 } }
                }
            }
        });
    }

    borrowingTrendsTimeframeSelect.addEventListener('change', function() {
        const timeframe = this.value;
        if (timeframe === 'custom') {
            customBorrowingRangeDiv.style.display = 'flex';
        } else {
            customBorrowingRangeDiv.style.display = 'none';
            loadBorrowingTrends(timeframe);
        }
    });

    function updateBorrowingTrends(type) {
        let start = null;
        let end = null;
        if (type === 'custom') {
            start = borrowingStartInput.value;
            end = borrowingEndInput.value;
            if (!start || !end) {
                alert('Please select both start and end dates for custom range.');
                return;
            }
        }
        loadBorrowingTrends(borrowingTrendsTimeframeSelect.value, start, end);
    }

    function loadUserActivity(timeframe, startDate = null, endDate = null) {
        showLoading();
        const checkouts = {};
        const returns = {};
        const now = new Date();

        dbRef.child('transactions').orderByChild('transactionDate').once('value', snapshot => {
            const transactions = snapshotToArray(snapshot);
            let filteredTransactions = transactions;

            if (timeframe === 'last7days') {
                const pastDate = new Date(now);
                pastDate.setDate(now.getDate() - 7);
                filteredTransactions = transactions.filter(t => t.transactionDate && new Date(t.transactionDate) >= pastDate);
            } else if (timeframe === 'last30days') {
                const pastDate = new Date(now);
                pastDate.setDate(now.getDate() - 30);
                filteredTransactions = transactions.filter(t => t.transactionDate && new Date(t.transactionDate) >= pastDate);
            } else if (timeframe === 'thisMonth') {
                filteredTransactions = transactions.filter(t => t.transactionDate && new Date(t.transactionDate).getMonth() === now.getMonth() && new Date(t.transactionDate).getFullYear() === now.getFullYear());
            } else if (timeframe === 'lastMonth') {
                const lastMonth = now.getMonth() === 0 ? 11 : now.getMonth() - 1;
                const year = now.getMonth() === 0 ? now.getFullYear() - 1 : now.getFullYear();
                filteredTransactions = transactions.filter(t => t.transactionDate && new Date(t.transactionDate).getMonth() === lastMonth && new Date(t.transactionDate).getFullYear() === year);
            } else if (timeframe === 'thisYear') {
                filteredTransactions = transactions.filter(t => t.transactionDate && new Date(t.transactionDate).getFullYear() === now.getFullYear());
            } else if (timeframe === 'allTime') {
                // Keep all transactions
            } else if (timeframe === 'custom' && startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                filteredTransactions = transactions.filter(t => t.transactionDate && new Date(t.transactionDate) >= start && new Date(t.transactionDate) <= end);
            }

            filteredTransactions.forEach(transaction => {
                const userId = transaction.memberId;
                if (transaction.type === 'checkout') {
                    checkouts[userId] = (checkouts[userId] || 0) + 1;
                } else if (transaction.type === 'return') {
                    returns[userId] = (returns[userId] || 0) + 1;
                }
            });

            const userLabels = [];
            const checkoutData = [];
            const returnData = [];

            const allUserIds = [...new Set([...Object.keys(checkouts), ...Object.keys(returns)])];
            const topUsers = allUserIds.slice(0, 5); // Display top 5 users

            Promise.all(topUsers.map(userId => dbRef.child('members').child(userId).once('value')))
                .then(snapshots => {
                    snapshots.forEach(snapshot => {
                        if (snapshot.exists()) {
                            const member = snapshot.val();
                            const userId = snapshot.key;
                            userLabels.push(member.name || 'User ID: ' + userId);
                            checkoutData.push(checkouts[userId] || 0);
                            returnData.push(returns[userId] || 0);
                        }
                    });
                    renderUserActivityChart(userLabels, checkoutData, returnData);
                })
                .finally(hideLoading);
        });
    }

    function renderUserActivityChart(labels, checkoutData, returnData) {
        if (userActivityChart) {
            userActivityChart.destroy();
        }
        userActivityChart = new Chart(userActivityChartCanvas, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Checkouts',
                    data: checkoutData,
                    backgroundColor: 'rgba(255, 99, 132, 0.7)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                }, {
                    label: 'Returns',
                    data: returnData,
                    backgroundColor: 'rgba(75, 192, 192, 0.7)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Count',
                            font: { size: 10 }
                        },
                        ticks: { fontSize: 8 }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'User',
                            font: { size: 10 }
                        },
                        ticks: { fontSize: 8 }
                    }
                },
                plugins: {
                    title: { display: true, text: 'User Activity', font: { size: 12 } }
                }
            }
        });
    }

    userActivityTimeframeSelect.addEventListener('change', function() {
        const timeframe = this.value;
        if (timeframe === 'custom') {
            customUserActivityRangeDiv.style.display = 'flex';
        } else {
            customUserActivityRangeDiv.style.display = 'none';
            loadUserActivity(timeframe);
        }
    });

    function updateUserActivityChart(type) {
        let start = null;
        let end = null;
        if (type === 'custom') {
            start = userActivityStartInput.value;
            end = userActivityEndInput.value;
            if (!start || !end) {
                alert('Please select both start and end dates for custom range.');
                return;
            }
        }
        loadUserActivity(userActivityTimeframeSelect.value, start, end);
    }

    function loadPopularBooks(timeframe, limit) {
        showLoading();
        dbRef.child('transactions').orderByChild('checkoutDate').once('value', snapshot => {
            const transactions = snapshotToArray(snapshot);
            const bookCheckoutCounts = {};
            const now = new Date();
            let filteredTransactions = transactions;

            if (timeframe === 'last30days') {
                const pastDate = new Date(now);
                pastDate.setDate(now.getDate() - 30);
                filteredTransactions = transactions.filter(t => t.checkoutDate && new Date(t.checkoutDate) >= pastDate);
            } else if (timeframe === 'thisYear') {
                filteredTransactions = transactions.filter(t => t.checkoutDate && new Date(t.checkoutDate).getFullYear() === now.getFullYear());
            } else if (timeframe === 'allTime') {
                // Keep all transactions
            }

            filteredTransactions.forEach(transaction => {
                bookCheckoutCounts[transaction.bookId] = (bookCheckoutCounts[transaction.bookId] || 0) + 1;
            });

            const sortedTrends = Object.entries(bookCheckoutCounts).sort(([, countA], [, countB]) => countB - countA).slice(0, limit);
            const labels = [];
            const data = [];

            Promise.all(sortedTrends.map(([bookId]) => dbRef.child('books').child(bookId).once('value')))
                .then(snapshots => {
                    snapshots.forEach(snapshot => {
                        if (snapshot.exists()) {
                            labels.push(snapshot.val().title || 'N/A');
                            data.push(bookCheckoutCounts[snapshot.key] || 0);
                        }
                    });
                    renderBookPopularityChart(labels, data);
                })
                .finally(hideLoading);
        });
    }

    function renderBookPopularityChart(labels, data) {
        if (bookPopularityChart) {
            bookPopularityChart.destroy();
        }
        bookPopularityChart = new Chart(bookPopularityChartCanvas, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)',
                        'rgba(255, 159, 64, 0.7)',
                        'rgba(120, 200, 100, 0.7)',
                        'rgba(200, 150, 255, 0.7)',
                        'rgba(255, 100, 200, 0.7)',
                        'rgba(100, 200, 255, 0.7)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)',
                        'rgba(120, 200, 100, 1)',
                        'rgba(200, 150, 255, 1)',
                        'rgba(255, 100, 200, 1)',
                        'rgba(100, 200, 255, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                plugins: {
                    title: { display: true, text: `Top ${popularityLimitSelect.value} Books`, font: { size: 12 } },
                    legend: { position: 'bottom', labels: { usePointStyle: true, fontSize: 8 } }
                }
            }
        });
    }

    popularityTimeframeSelect.addEventListener('change', updateBookPopularity);
    popularityLimitSelect.addEventListener('change', updateBookPopularity);

    function updateBookPopularity() {
        loadPopularBooks(popularityTimeframeSelect.value, parseInt(popularityLimitSelect.value));
    }

    reportTypeSelect.addEventListener('change', function() {
        const reportType = this.value;
        dateRangeGroup.style.display = reportType === 'book_borrowing' || reportType === 'user_borrowing' || reportType === 'transaction_log' || reportType === 'new_members' || reportType === 'new_books' ? 'flex' : 'none';
        bookSelectGroup.style.display = reportType === 'book_borrowing' ? 'block' : 'none';
        userSelectGroup.style.display = reportType === 'user_borrowing' ? 'block' : 'none';
        customReportOutputDiv.innerHTML = ''; // Clear previous report
    });

    async function generateCustomReport() {
        const reportType = reportTypeSelect.value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        let reportData = [];
        customReportOutputDiv.innerHTML = '<p style="font-size: 0.9em;">Generating report...</p>';
        showLoading();

        try {
            if (reportType === 'book_borrowing') {
                const bookId = selectedBookSelect.value;
                if (!bookId) {
                    alert('Please select a book.');
                    hideLoading();
                    return;
                }
                const bookSnapshot = await dbRef.child('books').child(bookId).once('value');
                const transactionsSnapshot = await dbRef.child('transactions').orderByChild('bookId').equalTo(bookId).once('value');
                const transactions = snapshotToArray(transactionsSnapshot).filter(t => (!startDate || (t.checkoutDate && new Date(t.checkoutDate) >= new Date(startDate))) && (!endDate || (t.checkoutDate && new Date(t.checkoutDate) <= new Date(endDate))));
                reportData.push(`<h3 style="font-size: 1em; margin-bottom: 0.5em;">Borrowing History: "${bookSnapshot.val()?.title || 'N/A'}"</h3>`);
                if (transactions.length > 0) {
                    let tableHTML = '<table class="report-table"><thead><tr><th>Member</th><th>Checkout Date</th><th>Due Date</th><th>Return Date</th><th>Status</th></tr></thead><tbody>';
                    for (const transaction of transactions) {
                        const memberSnapshot = await dbRef.child('members').child(transaction.memberId).once('value');
                        const member = memberSnapshot.val();
                        tableHTML += `<tr><td><span class="math-inline">\{member?\.name \|\| 'N/A'\}</td\><td\></span>{transaction.checkoutDate ? new Date(transaction.checkoutDate).toLocaleDateString() : 'N/A'}</td><td><span class="math-inline">\{transaction\.dueDate ? new Date\(transaction\.dueDate\)\.toLocaleDateString\(\) \: 'N/A'\}</td\><td\></span>{transaction.returnDate ? new Date(transaction.returnDate).toLocaleDateString() : 'N/A'}</td><td>${transaction.status || 'N/A'}</td></tr>`;
                    }
                    tableHTML += '</tbody></table>';
                    reportData.push(tableHTML);
                } else {
                    reportData.push('<p style="font-size: 0.9em;">No borrowing history found for this book within the selected date range.</p>');
                }
            } else if (reportType === 'user_borrowing') {
                const userId = selectedUserSelect.value;
                if (!userId) {
                    alert('Please select a user.');
                    hideLoading();
                    return;
                }
                const memberSnapshot = await dbRef.child('members').child(userId).once('value');
                const member = memberSnapshot.val();
                const transactionsSnapshot = await dbRef.child('transactions').orderByChild('memberId').equalTo(userId).once('value');
                const transactions = snapshotToArray(transactionsSnapshot).filter(t => (!startDate || (t.checkoutDate && new Date(t.checkoutDate) >= new Date(startDate))) && (!endDate || (t.checkoutDate && new Date(t.checkoutDate) <= new Date(endDate))));
                reportData.push(`<h3 style="font-size: 1em; margin-bottom: 0.5em;">Borrowing History: "${member?.name || 'N/A'}"</h3>`);
                if (transactions.length > 0) {
                    let tableHTML = '<table class="report-table"><thead><tr><th>Book</th><th>Checkout Date</th><th>Due Date</th><th>Return Date</th><th>Status</th></tr></thead><tbody>';
                    for (const transaction of transactions) {
                        const bookSnapshot = await dbRef.child('books').child(transaction.bookId).once('value');
                        const book = bookSnapshot.val();
                        tableHTML += `<tr><td><span class="math-inline">\{book?\.title \|\| 'N/A'\}</td\><td\></span>{transaction.checkoutDate ? new Date(transaction.checkoutDate).toLocaleDateString() : 'N/A'}</td><td><span class="math-inline">\{transaction\.dueDate ? new Date\(transaction\.dueDate\)\.toLocaleDateString\(\) \: 'N/A'\}</td\><td\></span>{transaction.returnDate ? new Date(transaction.returnDate).toLocaleDateString() : 'N/A'}</td><td>${transaction.status || 'N/A'}</td></tr>`;
                    }
                    tableHTML += '</tbody></table>';
                    reportData.push(tableHTML);
                } else {
                    reportData.push('<p style="font-size: 0.9em;">No borrowing history found for this user within the selected date range.</p>');
                }
            } else if (reportType === 'transaction_log') {
                const transactionsSnapshot = await dbRef.child('transactions').orderByChild('transactionDate').once('value');
                const transactions = snapshotToArray(transactionsSnapshot).filter(t => (!startDate || (t.transactionDate && new Date(t.transactionDate) >= new Date(startDate))) && (!endDate || (t.transactionDate && new Date(t.transactionDate) <= new Date(endDate))));
                reportData.push('<h3 style="font-size: 1em; margin-bottom: 0.5em;">Transaction Log</h3>');
                if (transactions.length > 0) {
                    let tableHTML = '<table class="report-table"><thead><tr><th>Member</th><th>Book</th><th>Type</th><th>Date</th></tr></thead><tbody>';
                    for (const transaction of transactions) {
                        const memberSnapshot = await dbRef.child('members').child(transaction.memberId).once('value');
                        const member = memberSnapshot.val();
                        const bookSnapshot = await dbRef.child('books').child(transaction.bookId).once('value');
                        const book = bookSnapshot.val();
                        tableHTML += `<tr><td><span class="math-inline">\{member?\.name \|\| 'N/A'\}</td\><td\></span>{book?.title || 'N/A'}</td><td><span class="math-inline">\{transaction\.type \|\| 'N/A'\}</td\><td\></span>{transaction.transactionDate ? new Date(transaction.transactionDate).toLocaleDateString() : 'N/A'}</td></tr>`;
                    }
                    tableHTML += '</tbody></table>';
                    reportData.push(tableHTML);
                } else {
                    reportData.push('<p style="font-size: 0.9em;">No transactions found within the selected date range.</p>');
                }
            } else if (reportType === 'new_members') {
                const membersSnapshot = await dbRef.child('members').orderByChild('joinDate').once('value');
                const newMembers = snapshotToArray(membersSnapshot).filter(m => (!startDate || (m.joinDate && new Date(m.joinDate) >= new Date(startDate))) && (!endDate || (m.joinDate && new Date(m.joinDate) <= new Date(endDate))));
                reportData.push('<h3 style="font-size: 1em; margin-bottom: 0.5em;">New Members Registered</h3>');
                if (newMembers.length > 0) {
                    let tableHTML = '<table class="report-table"><thead><tr><th>Name</th><th>Registration Date</th><th>Email</th></tr></thead><tbody>';
                    for (const member of newMembers) {
                        tableHTML += `<tr><td><span class="math-inline">\{member\.name \|\| 'N/A'\}</td\><td\></span>{member.joinDate ? new Date(member.joinDate).toLocaleDateString() : 'N/A'}</td><td>${member.email || 'N/A'}</td></tr>`;
                    }
                    tableHTML += '</tbody></table>';
                    reportData.push(tableHTML);
                } else {
                    reportData.push('<p style="font-size: 0.9em;">No new members registered within the selected date range.</p>');}
            } else if (reportType === 'new_books') {
                const booksSnapshot = await dbRef.child('books').orderByChild('addedDate').once('value');
                const newBooks = snapshotToArray(booksSnapshot).filter(b => (!startDate || (b.addedDate && new Date(b.addedDate) >= new Date(startDate))) && (!endDate || (b.addedDate && new Date(b.addedDate) <= new Date(endDate))));
                reportData.push('<h3 style="font-size: 1em; margin-bottom: 0.5em;">New Books Added</h3>');
                if (newBooks.length > 0) {
                    let tableHTML = '<table class="report-table"><thead><tr><th>Title</th><th>Author</th><th>Added Date</th></tr></thead><tbody>';
                    for (const book of newBooks) {
                        tableHTML += `<tr><td>${book.title || 'N/A'}</td><td>${book.author || 'N/A'}</td><td>${book.addedDate ? new Date(book.addedDate).toLocaleDateString() : 'N/A'}</td></tr>`;
                    }
                    tableHTML += '</tbody></table>';
                    reportData.push(tableHTML);
                } else {
                    reportData.push('<p style="font-size: 0.9em;">No new books added within the selected date range.</p>');
                }
            }

            customReportOutputDiv.innerHTML = reportData.join('');

        } catch (error) {
            console.error("Error generating custom report:", error);
            customReportOutputDiv.innerHTML = '<p style="font-size: 0.9em;">Error generating report.</p>';
        } finally {
            hideLoading();
        }
    }

    // Initialize date pickers for custom ranges
    flatpickr("#borrowingStart", { dateFormat: "Y-m-d" });
    flatpickr("#borrowingEnd", { dateFormat: "Y-m-d" });
    flatpickr("#userActivityStart", { dateFormat: "Y-m-d" });
    flatpickr("#userActivityEnd", { dateFormat: "Y-m-d" });
    flatpickr("#startDate", { dateFormat: "Y-m-d" });
    flatpickr("#endDate", { dateFormat: "Y-m-d" });

    // Logout functionality
    const logoutBtn = document.getElementById('logoutBtn');
    logoutBtn.addEventListener('click', () => {
        firebase.auth().signOut()
            .then(() => {
                window.location.href = 'index.html'; // Redirect to login page
            })
            .catch((error) => {
                console.error('Logout failed:', error);
                alert('Logout failed. Please try again.');
            });
    });
</script>
<script>
    // <![CDATA[  <-- For SVG support
    if ('WebSocket' in window) {
        (function () {
            function refreshCSS() {
                var sheets = [].slice.call(document.getElementsByTagName("link"));
                var head = document.getElementsByTagName("head")[0];
                for (var i = 0; i < sheets.length; ++i) {
                    var elem = sheets[i];
                    var parent = elem.parentElement || head;
                    parent.removeChild(elem);
                    var rel = elem.rel;
                    if (elem.href && typeof rel != "string" || rel.length == 0 || rel.toLowerCase() == "stylesheet") {
                        var url = elem.href.replace(/(&|\?)_cacheOverride=\d+/, '');
                        elem.href = url + (url.indexOf('?') >= 0 ? '&' : '?') + '_cacheOverride=' + (new Date().valueOf());
                    }
                    parent.appendChild(elem);
                }
            }
            var protocol = window.location.protocol === 'http:' ? 'ws://' : 'wss://';
            var address = protocol + window.location.host + window.location.pathname + '/ws';
            var socket = new WebSocket(address);
            socket.onmessage = function (msg) {
                if (msg.data == 'reload') window.location.reload();
                else if (msg.data == 'refreshcss') refreshCSS();
            };
            if (sessionStorage && !sessionStorage.getItem('IsThisFirstTime_Log_From_Live-Server')) {
                console.log('Live reload enabled.');
                sessionStorage.setItem('IsThisFirstTime_Log_From_Live-Server', true);
            }
        })();
    }
    else {
        console.error('Upgrade your browser. This page cannot work properly.');
    }
    // ]]>
</script>
</body>
</html>